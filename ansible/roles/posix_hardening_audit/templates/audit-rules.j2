# {{ ansible_managed }}
# ==============================================================================
# POSIX Hardening Audit Rules
# ==============================================================================
# These rules monitor critical system files and security-relevant activities
# Generated by: posix_hardening_audit role
# ==============================================================================

# Remove all previous rules
-D

# Buffer size (increase if high traffic)
-b 8192

# Failure mode: 0=silent 1=printk 2=panic
-f 1

# ==============================================================================
# FILE WATCHES - Authentication and Identity
# ==============================================================================
{% if posix_audit_watch_passwd | bool %}
# Monitor password file
-w /etc/passwd -p wa -k passwd_changes
{% endif %}

{% if posix_audit_watch_shadow | bool %}
# Monitor shadow password file
-w /etc/shadow -p wa -k shadow_changes
{% endif %}

{% if posix_audit_watch_group | bool %}
# Monitor group file
-w /etc/group -p wa -k group_changes
{% endif %}

{% if posix_audit_watch_gshadow | bool %}
# Monitor shadow group file (if exists)
-w /etc/gshadow -p wa -k gshadow_changes
{% endif %}

{% if posix_audit_watch_sudoers | bool %}
# Monitor sudoers configuration
-w /etc/sudoers -p wa -k sudoers_changes
-w /etc/sudoers.d/ -p wa -k sudoers_changes
{% endif %}

# ==============================================================================
# FILE WATCHES - SSH Configuration
# ==============================================================================
{% if posix_audit_watch_sshd_config | bool %}
# Monitor SSH daemon configuration
-w /etc/ssh/sshd_config -p wa -k sshd_config
-w /etc/ssh/sshd_config.d/ -p wa -k sshd_config
{% endif %}

# ==============================================================================
# FILE WATCHES - PAM Configuration
# ==============================================================================
{% if posix_audit_watch_pam | bool %}
# Monitor PAM configuration
-w /etc/pam.d/ -p wa -k pam_changes
-w /etc/security/ -p wa -k pam_security_changes
{% endif %}

# ==============================================================================
# FILE WATCHES - Network Configuration
# ==============================================================================
{% if posix_audit_watch_hosts | bool %}
# Monitor hosts file
-w /etc/hosts -p wa -k hosts_changes
{% endif %}

{% if posix_audit_watch_network | bool %}
# Monitor network configuration
-w /etc/network/ -p wa -k network_changes
-w /etc/sysconfig/network -p wa -k network_changes
-w /etc/sysconfig/network-scripts/ -p wa -k network_changes
{% endif %}

# ==============================================================================
# FILE WATCHES - System Configuration
# ==============================================================================
{% if posix_audit_watch_sysctl | bool %}
# Monitor sysctl configuration
-w /etc/sysctl.conf -p wa -k sysctl_changes
-w /etc/sysctl.d/ -p wa -k sysctl_changes
{% endif %}

{% if posix_audit_watch_modprobe | bool %}
# Monitor kernel module configuration
-w /etc/modprobe.conf -p wa -k modprobe_changes
-w /etc/modprobe.d/ -p wa -k modprobe_changes
{% endif %}

# ==============================================================================
# SYSCALL AUDITING - Command Execution
# ==============================================================================
{% if posix_audit_monitor_execve | bool %}
# Monitor all command execution (can be verbose)
{% if posix_audit_arch_b64 | bool %}
-a exit,always -F arch=b64 -S execve -k command_execution
{% endif %}
{% if posix_audit_arch_b32 | bool %}
-a exit,always -F arch=b32 -S execve -k command_execution
{% endif %}
{% endif %}

# ==============================================================================
# SYSCALL AUDITING - File Deletions
# ==============================================================================
{% if posix_audit_monitor_unlink | bool %}
# Monitor file deletions
{% if posix_audit_arch_b64 | bool %}
-a always,exit -F arch=b64 -S unlink -S unlinkat -S rename -S renameat -k file_deletion
{% endif %}
{% if posix_audit_arch_b32 | bool %}
-a always,exit -F arch=b32 -S unlink -S unlinkat -S rename -S renameat -k file_deletion
{% endif %}
{% endif %}

# ==============================================================================
# SYSCALL AUDITING - Privilege Changes
# ==============================================================================
{% if posix_audit_monitor_setuid | bool %}
# Monitor setuid/setgid operations
{% if posix_audit_arch_b64 | bool %}
-a always,exit -F arch=b64 -S setuid -S setgid -S setreuid -S setregid -k privilege_escalation
{% endif %}
{% if posix_audit_arch_b32 | bool %}
-a always,exit -F arch=b32 -S setuid -S setgid -S setreuid -S setregid -k privilege_escalation
{% endif %}
{% endif %}

# ==============================================================================
# SYSCALL AUDITING - Kernel Module Operations
# ==============================================================================
{% if posix_audit_monitor_modules | bool %}
# Monitor kernel module loading/unloading
{% if posix_audit_arch_b64 | bool %}
-a always,exit -F arch=b64 -S init_module -S delete_module -k kernel_modules
{% endif %}
{% if posix_audit_arch_b32 | bool %}
-a always,exit -F arch=b32 -S init_module -S delete_module -k kernel_modules
{% endif %}
{% endif %}

# ==============================================================================
# SYSCALL AUDITING - Network Operations
# ==============================================================================
{% if posix_audit_monitor_network | bool %}
# Monitor network operations (very verbose - disabled by default)
{% if posix_audit_arch_b64 | bool %}
-a always,exit -F arch=b64 -S socket -S connect -S accept -k network_operations
{% endif %}
{% if posix_audit_arch_b32 | bool %}
-a always,exit -F arch=b32 -S socket -S connect -S accept -k network_operations
{% endif %}
{% endif %}

# ==============================================================================
# CUSTOM RULES
# ==============================================================================
{% if posix_audit_custom_rules | length > 0 %}
# Custom audit rules defined in variables
{% for rule in posix_audit_custom_rules %}
{{ rule }}
{% endfor %}
{% endif %}

# ==============================================================================
# FINALIZATION
# ==============================================================================
# Make configuration immutable (requires reboot to change)
# Uncomment to enable:
# -e 2
