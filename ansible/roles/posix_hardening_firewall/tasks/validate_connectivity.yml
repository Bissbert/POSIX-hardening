---
# ==============================================================================
# Validate Connectivity After Firewall Changes
# ==============================================================================
# Tests that SSH is still accessible after firewall hardening
# CRITICAL: Failure here triggers emergency rollback
# ==============================================================================

- name: Display connectivity validation phase
  ansible.builtin.debug:
    msg: |
      ========================================
      PHASE 6: CONNECTIVITY VALIDATION
      ========================================
      Testing SSH accessibility...
      This is CRITICAL - failure triggers rollback
  tags: [firewall, validation]

- name: Test local SSH port accessibility
  ansible.builtin.wait_for:
    host: "{{ posix_firewall_connectivity_test_host }}"
    port: "{{ posix_firewall_ssh_port }}"
    state: started
    timeout: "{{ posix_firewall_connectivity_test_timeout }}"
  register: ssh_port_test
  tags: [firewall, validation]

- name: Verify SSH port is in iptables rules
  ansible.builtin.shell: |
    {{ posix_firewall_iptables_bin }} -L INPUT -n | grep -q "dpt:{{ posix_firewall_ssh_port }}"
    echo $?
  register: ssh_rule_check
  changed_when: false
  failed_when: ssh_rule_check.stdout != "0"
  tags: [firewall, validation]

- name: Test external connectivity (optional)
  ansible.builtin.command: timeout 5 ping -c 1 8.8.8.8
  register: external_ping
  changed_when: false
  failed_when: false
  tags: [firewall, validation]

- name: Display external connectivity result
  ansible.builtin.debug:
    msg: |
      External connectivity: {{ 'WORKING' if external_ping.rc == 0 else 'BLOCKED (may be intentional)' }}
  tags: [firewall, validation]

- name: Verify established connections rule exists
  ansible.builtin.shell: |
    {{ posix_firewall_iptables_bin }} -L INPUT -n | grep -q "state RELATED,ESTABLISHED"
    echo $?
  register: established_rule_check
  changed_when: false
  failed_when: established_rule_check.stdout != "0"
  tags: [firewall, validation]

- name: Verify loopback interface is allowed
  ansible.builtin.shell: |
    {{ posix_firewall_iptables_bin }} -L INPUT -n | grep -q "lo"
    echo $?
  register: loopback_check
  changed_when: false
  failed_when: loopback_check.stdout != "0"
  tags: [firewall, validation]

- name: Check if admin IP rule exists (if configured)
  ansible.builtin.shell: |
    {{ posix_firewall_iptables_bin }} -L INPUT -n | grep -q "{{ posix_firewall_admin_ip }}"
    echo $?
  register: admin_ip_check
  changed_when: false
  failed_when: false
  when:
    - posix_firewall_admin_ip is defined
    - posix_firewall_admin_ip != ""
    - "':' not in posix_firewall_admin_ip"
  tags: [firewall, validation]

- name: Display admin IP rule status
  ansible.builtin.debug:
    msg: "Admin IP rule: {{ 'FOUND' if admin_ip_check.stdout == '0' else 'NOT FOUND' }}"
  when:
    - posix_firewall_admin_ip is defined
    - posix_firewall_admin_ip != ""
    - admin_ip_check is defined
  tags: [firewall, validation]

- name: Verify default policies are set correctly
  ansible.builtin.shell: |
    {{ posix_firewall_iptables_bin }} -L -n | grep -E "Chain (INPUT|OUTPUT|FORWARD)"
  register: policy_check
  changed_when: false
  tags: [firewall, validation]

- name: Display policy check results
  ansible.builtin.debug:
    msg: "{{ policy_check.stdout_lines }}"
  tags: [firewall, validation]

- name: Display connectivity validation success
  ansible.builtin.debug:
    msg: |
      ========================================
      CONNECTIVITY VALIDATION: PASSED
      ========================================
      All critical tests passed:
        - SSH port {{ posix_firewall_ssh_port }}: ACCESSIBLE
        - SSH rule in iptables: VERIFIED
        - Established connections: ALLOWED
        - Loopback interface: ALLOWED
        - Default policies: CONFIGURED

      Firewall is functional and secure
      Proceeding to finalization...
      ========================================
  tags: [firewall, validation]
