#!/bin/sh
# ==============================================================================
# Firewall Safety Reset Script
# ==============================================================================
# Automatically generated by Ansible - posix_hardening_firewall role
# This script will reset the firewall to a permissive state after timeout
# to prevent permanent lockout from misconfigurations
# ==============================================================================

# Configuration
TIMEOUT={{ posix_firewall_safety_timeout }}
LOG_FILE="{{ posix_firewall_log_file }}"
IPTABLES="{{ posix_firewall_iptables_bin }}"
IP6TABLES="{{ posix_firewall_ip6tables_bin }}"

# Log function
log() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] $1" >> "$LOG_FILE"
}

# Main execution
log "Safety timeout started (PID: $$, timeout: ${TIMEOUT}s)"
log "Firewall will auto-reset if not cancelled within ${TIMEOUT} seconds"

# Wait for timeout
sleep "$TIMEOUT"

# If we reach here, timeout expired (script was not killed)
log "SAFETY TIMEOUT EXPIRED - Resetting firewall to permissive state"

# Reset IPv4 firewall to permissive state
if [ -x "$IPTABLES" ]; then
    $IPTABLES -F
    $IPTABLES -X
    $IPTABLES -Z
    $IPTABLES -P INPUT ACCEPT
    $IPTABLES -P FORWARD ACCEPT
    $IPTABLES -P OUTPUT ACCEPT
    log "IPv4 firewall reset to ACCEPT ALL"
else
    log "ERROR: iptables binary not found or not executable: $IPTABLES"
fi

# Reset IPv6 firewall to permissive state
{% if posix_firewall_ipv6_enabled %}
if [ -x "$IP6TABLES" ]; then
    $IP6TABLES -F
    $IP6TABLES -X
    $IP6TABLES -Z
    $IP6TABLES -P INPUT ACCEPT
    $IP6TABLES -P FORWARD ACCEPT
    $IP6TABLES -P OUTPUT ACCEPT
    log "IPv6 firewall reset to ACCEPT ALL"
else
    log "WARNING: ip6tables binary not found or not executable: $IP6TABLES"
fi
{% else %}
log "IPv6 firewall reset skipped (IPv6 not enabled)"
{% endif %}

# Send notification to system log
logger -t firewall_safety "CRITICAL: Firewall safety timeout triggered - Rules reset to permissive state"

# Display message to console (if available)
echo "$(date): FIREWALL AUTO-RESET TRIGGERED" >> /dev/console 2>/dev/null || true

log "Safety timeout completed - Firewall is now in permissive state"
log "Manual intervention required to restore secure firewall configuration"
log "Check Ansible logs and backups in {{ posix_firewall_backup_dir }}/"

# Clean up PID file
rm -f "{{ posix_firewall_reset_pid_file }}"

exit 0
