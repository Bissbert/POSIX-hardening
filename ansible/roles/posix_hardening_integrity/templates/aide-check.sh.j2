#!/bin/bash
# {{ ansible_managed }}
# ==============================================================================
# AIDE Integrity Check Script
# ==============================================================================
# Generated by: posix_hardening_integrity role
# Run periodic integrity checks and report violations
# ==============================================================================

set -euo pipefail

# Configuration
AIDE_BIN="/usr/bin/aide"
AIDE_CONF="{{ posix_integrity_aide_conf }}"
AIDE_DB="{{ posix_integrity_aide_db }}"
AIDE_DB_NEW="{{ posix_integrity_aide_db_new }}"
REPORT_FILE="{{ posix_integrity_report_file }}"
REPORT_DIR="{{ posix_integrity_report_dir }}"
HOSTNAME="{{ ansible_hostname }}"
LOG_FILE="{{ posix_integrity_aide_log }}"

# Email settings
{% if posix_integrity_enable_email | bool %}
SEND_EMAIL=true
EMAIL_TO="{{ posix_integrity_email_recipient }}"
EMAIL_SUBJECT="{{ posix_integrity_email_subject }}"
{% else %}
SEND_EMAIL=false
{% endif %}

# Ensure report directory exists
mkdir -p "$REPORT_DIR"

# Log function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

# Check if AIDE is installed
if [ ! -x "$AIDE_BIN" ]; then
    log "ERROR: AIDE not found at $AIDE_BIN"
    exit 1
fi

# Check if database exists
if [ ! -f "$AIDE_DB" ] && [ ! -f "$AIDE_DB.gz" ]; then
    log "ERROR: AIDE database not found at $AIDE_DB"
    log "Please initialize the database with: aide --init"
    exit 1
fi

# Run integrity check
log "Starting AIDE integrity check..."
TIMESTAMP=$(date '+%Y%m%d-%H%M%S')
REPORT_DATED="${REPORT_DIR}/aide_report_${TIMESTAMP}.txt"

if $AIDE_BIN --check --config="$AIDE_CONF" > "$REPORT_DATED" 2>&1; then
    log "Integrity check completed: No changes detected"
    CHANGES_FOUND=false
else
    AIDE_EXIT_CODE=$?
    if [ $AIDE_EXIT_CODE -eq 1 ]; then
        log "WARNING: Integrity violations detected!"
        CHANGES_FOUND=true
    else
        log "ERROR: AIDE check failed with exit code $AIDE_EXIT_CODE"
        CHANGES_FOUND=true
    fi
fi

# Update latest report symlink
ln -sf "$(basename "$REPORT_DATED")" "${REPORT_FILE}"

# Send email notification if changes detected
if $CHANGES_FOUND && $SEND_EMAIL; then
    if command -v mail >/dev/null 2>&1; then
        mail -s "$EMAIL_SUBJECT" "$EMAIL_TO" < "$REPORT_DATED"
        log "Email notification sent to $EMAIL_TO"
    else
        log "WARNING: mail command not found, cannot send email"
    fi
fi

# Log to syslog if enabled
{% if posix_integrity_enable_syslog | bool %}
if $CHANGES_FOUND; then
    logger -t aide -p security.warning "AIDE integrity check detected changes on $HOSTNAME"
else
    logger -t aide -p security.info "AIDE integrity check completed successfully on $HOSTNAME"
fi
{% endif %}

# Clean up old reports
{% if posix_integrity_keep_reports | bool %}
if [ -d "$REPORT_DIR" ]; then
    find "$REPORT_DIR" -name "aide_report_*.txt" -type f -mtime +{{ posix_integrity_max_reports }} -delete
    log "Cleaned up reports older than {{ posix_integrity_max_reports }} days"
fi
{% endif %}

log "AIDE integrity check completed"
exit 0
