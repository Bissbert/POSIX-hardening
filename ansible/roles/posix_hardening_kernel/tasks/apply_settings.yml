---
# ==============================================================================
# Apply Kernel Security Settings via Sysctl
# ==============================================================================
# Uses ansible.posix.sysctl module for idempotent configuration
# ==============================================================================

# ------------------------------------------------------------------------------
# NETWORK SECURITY PARAMETERS
# ------------------------------------------------------------------------------

- name: Enable TCP SYN cookie protection
  ansible.posix.sysctl:
    name: net.ipv4.tcp_syncookies
    value: "{{ posix_kernel_tcp_syncookies }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Disable IP forwarding (IPv4)
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: "{{ posix_kernel_ip_forward }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Disable IP forwarding (IPv6)
  ansible.posix.sysctl:
    name: net.ipv6.conf.all.forwarding
    value: "{{ posix_kernel_ipv6_forwarding }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl
  when: ansible_facts.get('kernel', {}).get('ipv6', {}).get('enabled', false)

- name: Disable sending ICMP redirects (all interfaces)
  ansible.posix.sysctl:
    name: net.ipv4.conf.all.send_redirects
    value: "{{ posix_kernel_send_redirects_all }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Disable sending ICMP redirects (default)
  ansible.posix.sysctl:
    name: net.ipv4.conf.default.send_redirects
    value: "{{ posix_kernel_send_redirects_default }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Disable acceptance of source routed packets (IPv4 all)
  ansible.posix.sysctl:
    name: net.ipv4.conf.all.accept_source_route
    value: "{{ posix_kernel_accept_source_route_ipv4_all }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Disable acceptance of source routed packets (IPv4 default)
  ansible.posix.sysctl:
    name: net.ipv4.conf.default.accept_source_route
    value: "{{ posix_kernel_accept_source_route_ipv4_default }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Disable acceptance of source routed packets (IPv6 all)
  ansible.posix.sysctl:
    name: net.ipv6.conf.all.accept_source_route
    value: "{{ posix_kernel_accept_source_route_ipv6_all }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl
  when: ansible_facts.get('kernel', {}).get('ipv6', {}).get('enabled', false)

- name: Disable acceptance of source routed packets (IPv6 default)
  ansible.posix.sysctl:
    name: net.ipv6.conf.default.accept_source_route
    value: "{{ posix_kernel_accept_source_route_ipv6_default }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl
  when: ansible_facts.get('kernel', {}).get('ipv6', {}).get('enabled', false)

- name: Disable acceptance of ICMP redirects (IPv4 all)
  ansible.posix.sysctl:
    name: net.ipv4.conf.all.accept_redirects
    value: "{{ posix_kernel_accept_redirects_ipv4_all }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Disable acceptance of ICMP redirects (IPv4 default)
  ansible.posix.sysctl:
    name: net.ipv4.conf.default.accept_redirects
    value: "{{ posix_kernel_accept_redirects_ipv4_default }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Disable acceptance of ICMP redirects (IPv6 all)
  ansible.posix.sysctl:
    name: net.ipv6.conf.all.accept_redirects
    value: "{{ posix_kernel_accept_redirects_ipv6_all }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl
  when: ansible_facts.get('kernel', {}).get('ipv6', {}).get('enabled', false)

- name: Disable acceptance of ICMP redirects (IPv6 default)
  ansible.posix.sysctl:
    name: net.ipv6.conf.default.accept_redirects
    value: "{{ posix_kernel_accept_redirects_ipv6_default }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl
  when: ansible_facts.get('kernel', {}).get('ipv6', {}).get('enabled', false)

- name: Disable acceptance of secure ICMP redirects (all)
  ansible.posix.sysctl:
    name: net.ipv4.conf.all.secure_redirects
    value: "{{ posix_kernel_secure_redirects_all }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Disable acceptance of secure ICMP redirects (default)
  ansible.posix.sysctl:
    name: net.ipv4.conf.default.secure_redirects
    value: "{{ posix_kernel_secure_redirects_default }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Enable logging of martian packets (all)
  ansible.posix.sysctl:
    name: net.ipv4.conf.all.log_martians
    value: "{{ posix_kernel_log_martians_all }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Enable logging of martian packets (default)
  ansible.posix.sysctl:
    name: net.ipv4.conf.default.log_martians
    value: "{{ posix_kernel_log_martians_default }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Enable reverse path filtering (all)
  ansible.posix.sysctl:
    name: net.ipv4.conf.all.rp_filter
    value: "{{ posix_kernel_rp_filter_all }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Enable reverse path filtering (default)
  ansible.posix.sysctl:
    name: net.ipv4.conf.default.rp_filter
    value: "{{ posix_kernel_rp_filter_default }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Ignore ICMP echo requests to broadcast/multicast
  ansible.posix.sysctl:
    name: net.ipv4.icmp_echo_ignore_broadcasts
    value: "{{ posix_kernel_icmp_echo_ignore_broadcasts }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Ignore bogus ICMP error responses
  ansible.posix.sysctl:
    name: net.ipv4.icmp_ignore_bogus_error_responses
    value: "{{ posix_kernel_icmp_ignore_bogus_error_responses }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

# ------------------------------------------------------------------------------
# TCP/IP STACK HARDENING
# ------------------------------------------------------------------------------

- name: Configure TCP timestamps
  ansible.posix.sysctl:
    name: net.ipv4.tcp_timestamps
    value: "{{ posix_kernel_tcp_timestamps }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Enable TCP selective acknowledgements
  ansible.posix.sysctl:
    name: net.ipv4.tcp_sack
    value: "{{ posix_kernel_tcp_sack }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Enable TCP forward acknowledgement
  ansible.posix.sysctl:
    name: net.ipv4.tcp_fack
    value: "{{ posix_kernel_tcp_fack }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Set TCP congestion control algorithm
  ansible.posix.sysctl:
    name: net.ipv4.tcp_congestion_control
    value: "{{ posix_kernel_tcp_congestion_control }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl
  failed_when: false  # Algorithm may not be available on all systems

- name: Set TCP SYN-ACK retries
  ansible.posix.sysctl:
    name: net.ipv4.tcp_synack_retries
    value: "{{ posix_kernel_tcp_synack_retries }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Set TCP SYN retries
  ansible.posix.sysctl:
    name: net.ipv4.tcp_syn_retries
    value: "{{ posix_kernel_tcp_syn_retries }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Set maximum TCP SYN backlog
  ansible.posix.sysctl:
    name: net.ipv4.tcp_max_syn_backlog
    value: "{{ posix_kernel_tcp_max_syn_backlog }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Set TCP FIN timeout
  ansible.posix.sysctl:
    name: net.ipv4.tcp_fin_timeout
    value: "{{ posix_kernel_tcp_fin_timeout }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Set TCP keepalive time
  ansible.posix.sysctl:
    name: net.ipv4.tcp_keepalive_time
    value: "{{ posix_kernel_tcp_keepalive_time }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Set TCP keepalive interval
  ansible.posix.sysctl:
    name: net.ipv4.tcp_keepalive_intvl
    value: "{{ posix_kernel_tcp_keepalive_intvl }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Set TCP keepalive probes
  ansible.posix.sysctl:
    name: net.ipv4.tcp_keepalive_probes
    value: "{{ posix_kernel_tcp_keepalive_probes }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

# ------------------------------------------------------------------------------
# MEMORY PROTECTION
# ------------------------------------------------------------------------------

- name: Enable address space layout randomization (ASLR)
  ansible.posix.sysctl:
    name: kernel.randomize_va_space
    value: "{{ posix_kernel_randomize_va_space }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Hide kernel pointers (kptr_restrict)
  ansible.posix.sysctl:
    name: kernel.kptr_restrict
    value: "{{ posix_kernel_kptr_restrict }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Restrict ptrace usage (Yama)
  ansible.posix.sysctl:
    name: kernel.yama.ptrace_scope
    value: "{{ posix_kernel_yama_ptrace_scope }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl
  failed_when: false  # Yama may not be available on all systems

# ------------------------------------------------------------------------------
# CORE DUMPS
# ------------------------------------------------------------------------------

- name: Prevent SUID/SGID programs from dumping core
  ansible.posix.sysctl:
    name: fs.suid_dumpable
    value: "{{ posix_kernel_suid_dumpable }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Append PID to core filename
  ansible.posix.sysctl:
    name: kernel.core_uses_pid
    value: "{{ posix_kernel_core_uses_pid }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

# ------------------------------------------------------------------------------
# PROCESS SECURITY
# ------------------------------------------------------------------------------

- name: Set maximum PID value
  ansible.posix.sysctl:
    name: kernel.pid_max
    value: "{{ posix_kernel_pid_max }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Set kernel panic timeout
  ansible.posix.sysctl:
    name: kernel.panic
    value: "{{ posix_kernel_panic }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Enable panic on oops
  ansible.posix.sysctl:
    name: kernel.panic_on_oops
    value: "{{ posix_kernel_panic_on_oops }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

# ------------------------------------------------------------------------------
# SHARED MEMORY
# ------------------------------------------------------------------------------

- name: Set maximum shared memory segment size
  ansible.posix.sysctl:
    name: kernel.shmmax
    value: "{{ posix_kernel_shmmax }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

- name: Set total shared memory pages
  ansible.posix.sysctl:
    name: kernel.shmall
    value: "{{ posix_kernel_shmall }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

# ------------------------------------------------------------------------------
# FILE DESCRIPTORS
# ------------------------------------------------------------------------------

- name: Set maximum number of file descriptors
  ansible.posix.sysctl:
    name: fs.file-max
    value: "{{ posix_kernel_file_max }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

# ------------------------------------------------------------------------------
# SYSRQ
# ------------------------------------------------------------------------------

- name: Disable SysRq key
  ansible.posix.sysctl:
    name: kernel.sysrq
    value: "{{ posix_kernel_sysrq }}"
    state: present
    sysctl_file: "{{ posix_kernel_config_file }}"
    reload: yes
  notify: reload sysctl

# ------------------------------------------------------------------------------
# FLUSH HANDLERS
# ------------------------------------------------------------------------------

- name: Flush handlers to apply all sysctl changes
  ansible.builtin.meta: flush_handlers
