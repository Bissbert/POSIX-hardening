---
# POSIX Hardening - Pre-flight Checks Playbook
# Run this before deployment to verify readiness

- name: Pre-flight Checks for POSIX Hardening
  hosts: all
  gather_facts: true
  become: true
  vars:
    preflight_errors: []
    preflight_warnings: []
    team_keys_dir: "{{ playbook_dir }}/team_keys"

  tasks:
    - name: Check Ansible Controller SSH Keys
      tags: [ssh_keys]
      block:
        - name: Check if team keys exist on controller
          ansible.builtin.stat:
            path: "{{ team_keys_dir }}/{{ item }}"
          delegate_to: localhost
          become: false
          register: controller_keys
          loop:
            - "ansible_ed25519"
            - "ansible_ed25519.pub"
            - "team_shared_ed25519"
            - "team_shared_ed25519.pub"
          failed_when: false

        - name: Display key status
          ansible.builtin.debug:
            msg:
              - "Team Keys Directory: {{ team_keys_dir }}"
              - "Ansible Key (private): {{ 'FOUND' if controller_keys.results[0].stat.exists else 'MISSING' }}"
              - "Ansible Key (public): {{ 'FOUND' if controller_keys.results[1].stat.exists else 'MISSING' }}"
              - "Team Key (private): {{ 'FOUND' if controller_keys.results[2].stat.exists else 'MISSING' }}"
              - "Team Key (public): {{ 'FOUND' if controller_keys.results[3].stat.exists else 'MISSING' }}"

        - name: Warn if keys not found
          ansible.builtin.set_fact:
            preflight_warnings: "{{ preflight_warnings + ['Team SSH keys not found. Generate with: cd ansible/team_keys && ./generate_keys.sh'] }}"
          when: >
            not controller_keys.results[0].stat.exists or
            not controller_keys.results[1].stat.exists or
            not controller_keys.results[2].stat.exists or
            not controller_keys.results[3].stat.exists

    - name: System Information
      ansible.builtin.debug:
        msg: |
          ========================================
          Target System Information
          ========================================
          Hostname: {{ ansible_hostname }}
          FQDN: {{ ansible_fqdn }}
          IP Address: {{ ansible_default_ipv4.address | default('N/A') }}
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Kernel: {{ ansible_kernel }}
          Architecture: {{ ansible_architecture }}
          CPU Cores: {{ ansible_processor_cores }}
          Total Memory: {{ ansible_memtotal_mb }} MB
          Python: {{ ansible_python_version }}
          ========================================

    - name: Check Operating System
      block:
        - name: Verify Debian-based system
          ansible.builtin.assert:
            that:
              - ansible_os_family == "Debian"
            fail_msg: "ERROR: Not a Debian-based system"
            success_msg: "✓ Debian-based system confirmed"
      rescue:
        - name: Add OS error
          ansible.builtin.set_fact:
            preflight_errors: "{{ preflight_errors + ['Not a Debian-based system'] }}"

    - name: Check SSH Configuration
      block:
        - name: Check current SSH port
          ansible.builtin.wait_for:
            port: "{{ ansible_port | default(22) }}"
            host: "{{ ansible_host | default(inventory_hostname) }}"
            timeout: 5
          delegate_to: localhost
          register: ssh_port_check

        - name: Check for SSH keys
          ansible.builtin.stat:
            path: "{{ item }}"
          loop:
            - "/root/.ssh/authorized_keys"
            - "/home/{{ ansible_user }}/.ssh/authorized_keys"
          register: ssh_keys_check

        - name: Verify at least one SSH key exists
          ansible.builtin.assert:
            that:
              - ssh_keys_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0
            fail_msg: "WARNING: No SSH authorized_keys found"
            success_msg: "✓ SSH keys found"
      rescue:
        - name: Add SSH warning
          ansible.builtin.set_fact:
            preflight_warnings: "{{ preflight_warnings + ['No SSH keys configured - password auth may be disabled!'] }}"

    - name: Check System Resources
      block:
        - name: Check available disk space
          ansible.builtin.shell: set -o pipefail && df -BM / | awk 'NR==2 {print $4}' | sed 's/M//'
          register: disk_space_check
          changed_when: false

        - name: Verify sufficient disk space
          ansible.builtin.assert:
            that:
              - disk_space_check.stdout | int > 500
            fail_msg: "WARNING: Low disk space"
            success_msg: "✓ Sufficient disk space ({{ disk_space_check.stdout }}MB free)"

        - name: Check memory usage
          ansible.builtin.shell: set -o pipefail && free -m | awk 'NR==2 {printf "%.0f", $3*100/$2}'
          register: memory_usage
          changed_when: false

        - name: Display memory status
          ansible.builtin.debug:
            msg: "Memory usage: {{ memory_usage.stdout }}%"
      rescue:
        - name: Add resource warning
          ansible.builtin.set_fact:
            preflight_warnings: "{{ preflight_warnings + ['Low system resources detected'] }}"

    - name: Check Required Commands
      block:
        - name: Check for required commands
          ansible.builtin.command: which {{ item }}
          loop:
            - iptables
            - sysctl
            - sed
            - awk
            - grep
            - systemctl
          register: commands_check
          changed_when: false
          failed_when: false

        - name: Report missing commands
          ansible.builtin.debug:
            msg: "WARNING: Command not found - {{ item.item }}"
          when: item.rc != 0
          loop: "{{ commands_check.results }}"
      rescue:
        - name: Add command warning
          ansible.builtin.set_fact:
            preflight_warnings: "{{ preflight_warnings + ['Some required commands are missing'] }}"

    - name: Check Network Connectivity
      block:
        - name: Test DNS resolution
          ansible.builtin.shell: nslookup google.com > /dev/null 2>&1 || host google.com > /dev/null 2>&1
          register: dns_check
          changed_when: false
          failed_when: false

        - name: Check internet connectivity
          ansible.builtin.uri:
            url: https://www.google.com
            method: HEAD
            timeout: 5
          delegate_to: "{{ inventory_hostname }}"
          register: internet_check
          failed_when: false

        - name: Report connectivity status
          ansible.builtin.debug:
            msg: |
              DNS Resolution: {{ 'OK' if dns_check.rc == 0 else 'FAILED' }}
              Internet Access: {{ 'OK' if internet_check.status is defined else 'LIMITED' }}

    - name: Check Existing Hardening
      block:
        - name: Check if toolkit already deployed
          ansible.builtin.stat:
            path: /opt/posix-hardening
          register: toolkit_check

        - name: Check for existing backups
          ansible.builtin.stat:
            path: /var/backups/hardening
          register: backup_check

        - name: Report existing deployment
          ansible.builtin.debug:
            msg: |
              Toolkit Present: {{ 'YES' if toolkit_check.stat.exists else 'NO' }}
              Backups Present: {{ 'YES' if backup_check.stat.exists else 'NO' }}

    - name: Check Running Services
      block:
        - name: Get list of running services
          ansible.builtin.systemd:
            name: "{{ item }}"
            state: started
          register: critical_services
          failed_when: false
          loop:
            - ssh
            - sshd

        - name: Count running services
          ansible.builtin.shell: set -o pipefail && systemctl list-units --state=running --type=service | grep -c ".service"
          register: service_count
          changed_when: false

        - name: Report service status
          ansible.builtin.debug:
            msg: "Running services: {{ service_count.stdout }}"

    - name: Generate Pre-flight Report
      block:
        - name: Create report content
          ansible.builtin.set_fact:
            preflight_report: |
              ========================================
              PRE-FLIGHT CHECK REPORT
              ========================================
              Host: {{ inventory_hostname }}
              Date: {{ ansible_date_time.iso8601 }}

              SYSTEM STATUS:
              - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
              - Kernel: {{ ansible_kernel }}
              - Uptime: {{ (ansible_uptime_seconds | default(0) | int) // 86400 }} days
              - Load Average: {{ ansible_load_average['1m'] | default('N/A') }}

              RESOURCES:
              - CPU Cores: {{ ansible_processor_cores }}
              - Memory: {{ ansible_memtotal_mb }}MB ({{ memory_usage.stdout | default('N/A') }}% used)
              - Disk Space: {{ disk_space_check.stdout | default('N/A') }}MB free

              SSH STATUS:
              - Port: {{ ansible_port | default(22) }}
              - Keys Present: {{ 'YES' if (ssh_keys_check.results | default([]) | selectattr('stat.exists', 'equalto', true) | list | length > 0) else 'NO' }}

              ERRORS: {{ preflight_errors | length }}
              {% for error in preflight_errors %}
              - {{ error }}
              {% endfor %}

              WARNINGS: {{ preflight_warnings | length }}
              {% for warning in preflight_warnings %}
              - {{ warning }}
              {% endfor %}

              RECOMMENDATION:
              {% if preflight_errors | length > 0 %}
              ❌ DO NOT PROCEED - Critical issues detected
              {% elif preflight_warnings | length > 2 %}
              ⚠️  PROCEED WITH CAUTION - Multiple warnings
              {% else %}
              ✅ READY FOR DEPLOYMENT
              {% endif %}
              ========================================

        - name: Display report
          ansible.builtin.debug:
            msg: "{{ preflight_report.split('\n') }}"

        - name: Save report to file
          ansible.builtin.copy:
            content: "{{ preflight_report }}"
            dest: "/tmp/preflight_report_{{ ansible_hostname }}_{{ ansible_date_time.epoch }}.txt"
            mode: '0644'
          delegate_to: localhost

        - name: Fail if critical errors
          ansible.builtin.fail:
            msg: "Pre-flight checks failed - critical errors detected"
          when: preflight_errors | length > 0
